#!/usr/bin/env ruby
require 'open-uri'
require 'base64'
require 'public_suffix'

gfwlist_url = 'https://autoproxy-gfwlist.googlecode.com/svn/trunk/gfwlist.txt'
extra_domains = [
  "bbc.com",
  "blogspot.com",
  "fastly.net",
  "githubusercontent.com",
  "google-analytics.com",
  "google.as",
  "google.co.jp",
  "google.co.id",
  "google.co.th",
  "google.co.uk",
  "google.com",
  "google.com.hk",
  "google.com.tw",
  "googlesyndication.com",
  "s3.amazonaws.com",
  "s3.feedly.com",
  "cloudfront.net",
  "ace-cdn.atlassian.com",
  "wufoo.com",
  "nextmedia.com",
  "cxense.com",
  "krxd.net",
  "chartbeat.net",
  "slack-files.com",
  "fbinfer.com",
  "line.naver.jp",
]

def get_hostname(rule)
  begin
    host = URI.parse(rule).host
    if PublicSuffix.valid?(host)
      return PublicSuffix.parse(host).domain
    elsif PublicSuffix.valid?('.' + host)
      tld = PublicSuffix.parse('.' + host).tld
      if tld.include?('.') and tld == host
        return tld
      end
    else
      puts 'Hostname not valid: ' + host
    end
    return nil
  rescue
    puts 'can not parse rule as url: ' + rule
    return nil
  end
end

enc = open(gfwlist_url).read
plain = Base64.decode64(enc)

domains = []
plain.each_line do |line|
  if line.include? '.*'
    next
  elsif line.include? '*'
    line = line.gsub('*', '/')
  end
  if line.start_with? '||'
    line = line.sub('||', '')
  elsif line.start_with? '|'
    line = line.sub('|', '')
  elsif line.start_with? '.'
    line = line.sub('.', '')
  end
  if line.start_with? '!' or line.start_with? '[' or line.start_with? '@'
    next
  end
  line.chomp!
  if line.length > 0
    if not line.start_with? 'http'
      line = 'http://' + line
    end
    hostname = get_hostname(line)
    if hostname
      domains.push(hostname)
    end
  end
end

domains.concat extra_domains
File.open('gfwlist.conf', 'w+') do |f|
  f.puts '# Generated by gfwlist2ipset at ' + Time.new.inspect
  domains.sort.uniq.each do |domain|
    f.puts('ipset=/' + domain + '/outwall')
  end
end
